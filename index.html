<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Main Courante √âlectronique - S√©curit√© Priv√©e</title>
    <style>
        /* === STYLES G√âN√âRAUX === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* === HEADER === */
        .header {
            background: #2c3e50;
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn-warning:hover {
            background: #d68910;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        /* === PANNEAU DE CONNEXION === */
        .login-panel {
            padding: 50px;
            text-align: center;
        }

        .login-panel h2 {
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        /* === MAIN CONTENT === */
        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .section h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .hidden {
            display: none !important;
        }

        /* === √âV√âNEMENTS === */
        .event-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .event-content {
            flex: 1;
        }

        .event-time {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .event-description {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .event-photo {
            max-width: 200px;
            max-height: 150px;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* === PHOTO PREVIEW === */
        .photo-preview {
            max-width: 300px;
            max-height: 200px;
            border-radius: 5px;
            margin-top: 10px;
        }

        /* === LOG === */
        .log-area {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .log-entry.success {
            color: #27ae60;
        }

        .log-entry.error {
            color: #e74c3c;
        }

        /* === STATS === */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
            font-size: 14px;
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }

            .login-panel {
                padding: 30px 20px;
            }

            .main-content {
                padding: 20px;
            }
        }

        /* === BUTTONS ACTIONS === */
        .actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div>
                <h1>üõ°Ô∏è Main Courante √âlectronique</h1>
                <p>Gestion des services de s√©curit√© priv√©e</p>
            </div>
            <div class="user-info hidden" id="userInfo">
                <span id="userName"></span>
                <!-- Bouton Ajouter Agent ajout√© -->
                <button class="btn btn-secondary" id="addAgentBtn" onclick="startAddAgent()" title="Ajouter un agent">‚ûï Ajouter Agent</button>
                <button class="btn btn-secondary" onclick="logout()">D√©connexion</button>
            </div>
        </div>

        <!-- PANNEAU DE CONNEXION -->
        <div class="login-panel" id="loginPanel">
            <h2>Connexion Agent</h2>
            <div class="form-group">
                <label for="loginId">Identifiant :</label>
                <input type="text" id="loginId" placeholder="Votre identifiant">
            </div>
            <div class="form-group">
                <label for="loginPassword">Mot de passe :</label>
                <input type="password" id="loginPassword" placeholder="Votre mot de passe">
            </div>
            <button class="btn btn-primary" onclick="login()">Se connecter</button>
            <p style="margin-top: 20px; color: #7f8c8d; font-size: 12px;">
                ‚ö†Ô∏è Authentification c√¥t√© client pour la d√©mo uniquement.<br>
                En production, utiliser une authentification s√©curis√©e c√¥t√© serveur.
            </p>
            <div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 5px; text-align: left;">
                <strong>üìã Comptes de d√©monstration :</strong>
                <ul style="margin-top: 10px; margin-left: 20px; color: #2c3e50;">
                    <li><code>jeanbaptiste</code> / <code>jb</code></li>
                    <li><code>josse</code> / <code>josse</code></li>
                    <li><code>admin</code> / <code>admin123</code></li>
                </ul>
            </div>
        </div>

        <!-- CONTENU PRINCIPAL -->
        <div class="main-content hidden" id="mainContent">
            <!-- PRISE DE SERVICE -->
            <div class="section" id="serviceStartSection">
                <h3>üìç Prise de Service</h3>
                <div class="form-group">
                    <label for="locationSelect">Lieu de service :</label>
                    <select id="locationSelect">
                        <option value="">-- S√©lectionnez un lieu --</option>
                        <option value="Site A - Centre Commercial">Site A - Centre Commercial</option>
                        <option value="Site B - Immeuble de Bureaux">Site B - Immeuble de Bureaux</option>
                        <option value="Site C - Entrep√¥t Logistique">Site C - Entrep√¥t Logistique</option>
                        <option value="Site D - R√©sidence Priv√©e">Site D - R√©sidence Priv√©e</option>
                        <option value="Site E - √âv√©nement">Site E - √âv√©nement</option>
                    </select>
                </div>
                <!-- Alerte: afficher la liste des agents connect√©s et permettre de s√©lectionner (multi-agent) -->
                <div class="form-group">
                    <label for="agentsConnected">Agents connect√©s pour la prise :</label>
                    <select id="agentsConnected" multiple size="3" style="height:auto;"></select>
                    <small style="color:#7f8c8d;">S√©lection multiple possible : Ctrl/Cmd + clic</small>
                </div>
                <button class="btn btn-success" onclick="startService()">üöÄ Prise de Service</button>
            </div>

            <!-- SESSION EN COURS -->
            <div class="section hidden" id="activeSessionSection">
                <h3>‚úÖ Session en cours</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Lieu</div>
                        <div class="stat-value" style="font-size: 18px;" id="currentLocation"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Heure de prise</div>
                        <div class="stat-value" style="font-size: 18px;" id="startTime"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">√âv√©nements enregistr√©s</div>
                        <div class="stat-value" id="eventCount">0</div>
                    </div>
                </div>

                <!-- S√©lecteur d'agent actif -->
                <div class="form-group">
                    <label for="activeAgentSelect">Agent actif (ajout d'√©v√©nements) :</label>
                    <select id="activeAgentSelect"></select>
                    <small style="color:#7f8c8d; display:block; margin-top:6px;">S√©lectionnez qui signera les √©v√©nements (par d√©faut : premier agent pr√©sent).</small>
                </div>

                <!-- AJOUT √âV√âNEMENT -->
                <h3>üìù Ajouter un √âv√©nement</h3>
                <div class="form-group">
                    <label for="eventDescription">Description :</label>
                    <textarea id="eventDescription" rows="3" placeholder="D√©crivez l'√©v√©nement..."></textarea>
                </div>
                <div class="form-group">
                    <label for="eventPhoto">Photo (optionnel) :</label>
                    <input type="file" id="eventPhoto" accept="image/*" onchange="previewPhoto()">
                    <img id="photoPreview" class="photo-preview hidden" alt="Aper√ßu photo">
                </div>
                <button class="btn btn-primary" onclick="addEvent()">‚ûï Ajouter l'√©v√©nement</button>

                <!-- LISTE DES √âV√âNEMENTS -->
                <h3 style="margin-top: 30px;">üìã Liste des √âv√©nements</h3>
                <div id="eventsList"></div>

                <!-- FIN DE SERVICE -->
                <div class="actions">
                    <button class="btn btn-danger" onclick="endService()">‚èπÔ∏è Fin de Service</button>
                </div>
            </div>

            <!-- GESTION & EXPORT -->
            <div class="section">
                <h3>‚öôÔ∏è Gestion & Export</h3>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-label">Sessions sauvegard√©es</div>
                        <div class="stat-value" id="sessionCount">0</div>
                    </div>
                </div>
                <div class="actions">
                    <button class="btn btn-primary" onclick="exportData()">üíæ Exporter l'historique JSON</button>
                    <button class="btn btn-warning" onclick="clearStorage()">üóëÔ∏è R√©initialiser le stockage</button>
                </div>
            </div>

            <!-- JOURNAL D'ACTIVIT√â -->
            <div class="section">
                <h3>üìú Journal d'Activit√©</h3>
                <div class="log-area" id="logArea"></div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION - √Ä PERSONNALISER
        // ========================================
        
        // ‚ö†Ô∏è WEBHOOK DISCORD : Collez votre URL de webhook Discord ici
        const DISCORD_WEBHOOK_URL = 'https://discord.com/api/webhooks/1371959510092091412/_hB3qx5J-x8ymBxopPMRZzBV-khEcgpHi6GKvUQHXfazb4RIrvd4SyB-Mf5kbfPB2oCY'; // REMPLACER PAR VOTRE WEBHOOK DISCORD
        
        // ‚ö†Ô∏è BACKEND PHP (optionnel) : URL de votre script PHP pour enregistrement SQL
        const BACKEND_URL = ''; // REMPLACER PAR L'URL DE save.php si utilis√©

        // ‚ö†Ô∏è WEBHOOK QUOTIDIEN (RAPPORT) : URL du webhook pour les rapports journaliers
        const DISCORD_DAILY_WEBHOOK_URL = 'https://discord.com/api/webhooks/1371959565616418857/_h7LRerUy5YGdZwN_RpnZRFWuEQIiXst3U7gESx3URGlgKaJyz42Y7vLb2dF2Vza2FmQ'; // REMPLACER PAR VOTRE WEBHOOK QUOTIDIEN (rapport 08:00)
        
        // ========================================
        // VARIABLES GLOBALES
        // ========================================
        let currentUser = null;
        let currentSession = null;
        let events = [];

        // Nouveaux objets pour multi-agent
        let loggedInAgents = []; // liste des agents connect√©s (chaque √©l√©ment : {id, name, loginTime})
        let addAgentMode = false; // flag utilis√© lorsque "Ajouter Agent" est cliqu√©
        // ========================================
        // COMPTES D√âMO (CLIENT-SIDE)
        // ========================================
        // ‚ö†Ô∏è Pour la d√©monstration uniquement - En production, authentifier c√¥t√© serveur
        const DEMO_ACCOUNTS = {
            'jeanbaptiste': { password: 'jb', name: 'Jean Baptiste' },
            'josse': { password: 'josse', name: 'Josse' },
            'admin': { password: 'admin123', name: 'Administrateur' }
        };

        // ========================================
        // AUTHENTIFICATION (CLIENT-SIDE DEMO)
        // ========================================
        
        /**
         * Connexion utilisateur (d√©mo c√¥t√© client)
         * ‚ö†Ô∏è EN PRODUCTION : Utiliser une authentification serveur s√©curis√©e (JWT, OAuth, etc.)
         * 
         * COMPTES D√âMO :
         * - agent1 / demo123
         * - agent2 / demo123
         * - admin / admin123
         */
        function login() {
            const loginId = document.getElementById('loginId').value.trim();
            const loginPassword = document.getElementById('loginPassword').value.trim();
            
            if (!loginId || !loginPassword) {
                alert('‚ö†Ô∏è Veuillez saisir un identifiant et un mot de passe.');
                return;
            }
            
            // V√©rification avec les comptes d√©mo
            if (DEMO_ACCOUNTS[loginId] && DEMO_ACCOUNTS[loginId].password === loginPassword) {
                const newUser = {
                    id: loginId,
                    name: DEMO_ACCOUNTS[loginId].name,
                    loginTime: new Date().toISOString()
                };

                // Si on est en "ajout d'agent" (bouton Ajouter Agent)
                if (addAgentMode) {
                    // Ajouter l'agent √† la liste des agents connect√©s
                    loggedInAgents.push(newUser);
                    addLog(`Agent ajout√©: ${newUser.name}`, 'success');

                    // Si une session en cours, l'ajouter √† la session
                    if (currentSession) {
                        currentSession.agents.push(newUser);
                        saveSessionToLocal();
                        refreshAgentsUI();
                    }

                    // remettre le flag et revenir √† l'interface principale
                    addAgentMode = false;
                    document.getElementById('loginPanel').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    document.getElementById('userInfo').classList.remove('hidden');

                    // remettre les champs login
                    document.getElementById('loginId').value = '';
                    document.getElementById('loginPassword').value = '';

                    return;
                }
                
                // login normal (principal)
                currentUser = newUser;

                // si pas d√©j√† dans loggedInAgents, ajouter
                const exists = loggedInAgents.some(a => a.id === currentUser.id);
                if (!exists) loggedInAgents.push(currentUser);

                // Afficher l'interface principale
                document.getElementById('loginPanel').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userName').textContent = `Agent: ${currentUser.name}`;
                
                addLog(`Connexion r√©ussie : ${currentUser.name}`, 'success');
                updateStats();

                // Rafra√Æchir UI agents
                refreshAgentsUI();
            } else {
                alert('‚ùå Identifiant ou mot de passe incorrect.\n\nComptes d√©mo :\n- agent1 / demo123\n- agent2 / demo123\n- admin / admin123');
            }
        }

        /**
         * D√©connexion utilisateur
         */
        function logout() {
            if (currentSession) {
                if (!confirm('‚ö†Ô∏è Une session est en cours. Voulez-vous vraiment vous d√©connecter ?')) {
                    return;
                }
            }
            
            currentUser = null;
            currentSession = null;
            events = [];
            loggedInAgents = [];
            
            document.getElementById('loginPanel').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('loginId').value = '';
            document.getElementById('loginPassword').value = '';
            
            addLog('D√©connexion effectu√©e', 'success');
        }

        // ========================================
        // GESTION DE SESSION
        // ========================================
        
        /**
         * Prise de service - D√©marre une nouvelle session
         */
        async function startService() {
            const location = document.getElementById('locationSelect').value;
            
            if (!location) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un lieu de service.');
                return;
            }

            // R√©cup√©rer agents s√©lectionn√©s dans la liste (multi-select)
            const agentsSelect = document.getElementById('agentsConnected');
            const selectedOptions = Array.from(agentsSelect.selectedOptions);
            if (selectedOptions.length === 0) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner au moins un agent pour la prise de service.');
                return;
            }
            const selectedAgents = selectedOptions.map(opt => {
                const agentId = opt.value;
                // retrouver dans loggedInAgents
                const a = loggedInAgents.find(x => x.id === agentId);
                return a ? a : { id: agentId, name: opt.textContent, loginTime: new Date().toISOString() };
            });

            const startTime = new Date();
            
            currentSession = {
                id: Date.now(),
                agents: selectedAgents.slice(), // tableau d'agents pr√©sents
                location: location,
                startTime: startTime.toISOString(),
                startTimeReadable: formatDateTime(startTime),
                endTime: null,
                duration: null,
                events: []
            };
            
            events = [];
            
            // Enregistrer en localStorage
            saveSessionToLocal();
            
            // Envoyer webhook Discord (start) - inclut la liste des agents
            await sendDiscordWebhook('start', currentSession);
            
            // Mettre √† jour l'interface
            document.getElementById('serviceStartSection').classList.add('hidden');
            document.getElementById('activeSessionSection').classList.remove('hidden');
            document.getElementById('currentLocation').textContent = location;
            document.getElementById('startTime').textContent = formatTime(startTime);

            // pr√©parer le select d'agent actif et par d√©faut choisir le premier agent
            refreshAgentsUI();

            addLog(`Prise de service - ${location}`, 'success');
            updateStats();
        }

        /**
         * Fin de service - Termine la session en cours
         */
        async function endService() {
            if (!currentSession) {
                alert('‚ö†Ô∏è Aucune session en cours.');
                return;
            }
            
            const endTime = new Date();
            const startTime = new Date(currentSession.startTime);
            const durationSeconds = Math.floor((endTime - startTime) / 1000);
            
            currentSession.endTime = endTime.toISOString();
            currentSession.endTimeReadable = formatDateTime(endTime);
            currentSession.duration = durationSeconds;
            currentSession.durationReadable = formatDuration(durationSeconds);
            currentSession.events = events;
            
            // Sauvegarder la session compl√®te
            saveCompletedSession();
            
            // Envoyer webhook Discord r√©capitulatif
            await sendDiscordWebhook('end', currentSession);
            
            // Envoyer au backend PHP (si configur√© et d√©comment√©)
            // await saveToBackend(currentSession);
            
            // R√©initialiser l'interface
            document.getElementById('serviceStartSection').classList.remove('hidden');
            document.getElementById('activeSessionSection').classList.add('hidden');
            document.getElementById('eventsList').innerHTML = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventPhoto').value = '';
            document.getElementById('photoPreview').classList.add('hidden');
            
            addLog(`Fin de service - Dur√©e: ${currentSession.durationReadable}`, 'success');
            
            currentSession = null;
            events = [];
            updateStats();
        }

        // ========================================
        // GESTION DES √âV√âNEMENTS
        // ========================================
        
        /**
         * Ajouter un √©v√©nement √† la session en cours
         */
        function addEvent() {
            if (!currentSession) {
                alert('‚ö†Ô∏è Aucune session en cours. Veuillez effectuer une prise de service.');
                return;
            }
            
            const description = document.getElementById('eventDescription').value.trim();
            
            if (!description) {
                alert('‚ö†Ô∏è Veuillez saisir une description pour l\'√©v√©nement.');
                return;
            }
            
            const photoInput = document.getElementById('eventPhoto');
            const timestamp = new Date();

            // qui est l'agent actif ?
            const activeAgentSelect = document.getElementById('activeAgentSelect');
            const activeAgentId = activeAgentSelect && activeAgentSelect.value ? activeAgentSelect.value : (currentSession.agents[0] ? currentSession.agents[0].id : null);
            const activeAgent = currentSession.agents.find(a => a.id === activeAgentId) || (currentSession.agents[0] || { id: 'unknown', name: 'Inconnu' });
            
            const event = {
                id: Date.now(),
                timestamp: timestamp.toISOString(),
                timestampReadable: formatDateTime(timestamp),
                description: description,
                photo: null,
                addedBy: activeAgent.name
            };
            
            // Traiter la photo si pr√©sente
            if (photoInput.files && photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    event.photo = e.target.result; // Base64
                    events.push(event);
                    displayEvent(event);
                    saveSessionToLocal();
                    addLog(`√âv√©nement ajout√© (avec photo) par ${event.addedBy}`, 'success');
                    resetEventForm();
                    updateStats();
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                events.push(event);
                displayEvent(event);
                saveSessionToLocal();
                addLog(`√âv√©nement ajout√© par ${event.addedBy}`, 'success');
                resetEventForm();
                updateStats();
            }
        }

        /**
         * Afficher un √©v√©nement dans l'interface
         */
        function displayEvent(event) {
            const eventsList = document.getElementById('eventsList');
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-item';
            eventDiv.id = 'event-' + event.id;
            
            let photoHtml = '';
            if (event.photo) {
                photoHtml = '<img src="' + event.photo + '" class="event-photo" alt="Photo √©v√©nement">';
            }

            // select pour r√©assigner l'agent auteur (quick "swipe"/select)
            let assignSelectHtml = '';
            if (currentSession && currentSession.agents && currentSession.agents.length > 0) {
                assignSelectHtml = '<div style="margin-top:8px;">' +
                    '<label style="font-size:12px;color:#7f8c8d;margin-right:6px;">Sign√© par :</label>' +
                    '<select onchange="reassignEventAgent(' + event.id + ', this.value)">' +
                    currentSession.agents.map(a => {
                        return '<option value="' + a.id + '"' + (a.name === event.addedBy ? ' selected' : '') + '>' + a.name + '</option>';
                    }).join('') +
                    '</select>' +
                    '</div>';
            }

            eventDiv.innerHTML = 
                '<div class="event-content">' +
                    '<div class="event-time">‚è∞ ' + event.timestampReadable + ' ‚Äî <strong style="font-size:12px;color:#2c3e50;">' + escapeHtml(event.addedBy || 'Inconnu') + '</strong></div>' +
                    '<div class="event-description">' + escapeHtml(event.description) + '</div>' +
                    photoHtml +
                    assignSelectHtml +
                '</div>' +
                '<button class="btn btn-danger" onclick="deleteEvent(' + event.id + ')">üóëÔ∏è</button>';
            
            eventsList.appendChild(eventDiv);
        }

        /**
         * R√©assigner l'agent auteur d'un √©v√©nement
         */
        function reassignEventAgent(eventId, agentId) {
            const ev = events.find(e => e.id === eventId);
            if (!ev) return;
            const agent = currentSession.agents.find(a => a.id === agentId);
            if (!agent) return;
            ev.addedBy = agent.name;
            // Mettre √† jour affichage
            const el = document.getElementById('event-' + eventId);
            if (el) {
                // mettre √† jour la partie time/author
                const timeDiv = el.querySelector('.event-time');
                if (timeDiv) {
                    timeDiv.innerHTML = '‚è∞ ' + ev.timestampReadable + ' ‚Äî <strong style="font-size:12px;color:#2c3e50;">' + escapeHtml(ev.addedBy) + '</strong>';
                }
            }
            saveSessionToLocal();
            addLog(`√âv√©nement ${eventId} r√©assign√© √† ${agent.name}`, 'success');
        }

        /**
         * Supprimer un √©v√©nement
         */
        function deleteEvent(eventId) {
            if (!confirm('Voulez-vous vraiment supprimer cet √©v√©nement ?')) {
                return;
            }
            
            events = events.filter(function(e) { return e.id !== eventId; });
            const eventElement = document.getElementById('event-' + eventId);
            if (eventElement) {
                eventElement.remove();
            }
            saveSessionToLocal();
            addLog('√âv√©nement supprim√©', 'success');
            updateStats();
        }

        /**
         * R√©initialiser le formulaire d'√©v√©nement
         */
        function resetEventForm() {
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventPhoto').value = '';
            document.getElementById('photoPreview').classList.add('hidden');
        }

        /**
         * Pr√©visualiser la photo s√©lectionn√©e
         */
        function previewPhoto() {
            const photoInput = document.getElementById('eventPhoto');
            const preview = document.getElementById('photoPreview');
            
            if (photoInput.files && photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                preview.classList.add('hidden');
            }
        }

        // ========================================
        // WEBHOOK DISCORD
        // ========================================
        
        /**
         * Envoyer un webhook Discord
         * @param {string} type - Type de webhook ('start' ou 'end')
         * @param {object} session - Donn√©es de session
         */
        async function sendDiscordWebhook(type, session) {
            if (!DISCORD_WEBHOOK_URL) {
                addLog('‚ö†Ô∏è Webhook Discord non configur√©', 'error');
                return;
            }
            
            try {
                let content = '';
                
                if (type === 'start') {
                    content = 'üöÄ **PRISE DE SERVICE**\n' +
                              'üë• Agents: ' + session.agents.map(a => a.name).join(', ') + '\n' +
                              'üìç Lieu: ' + session.location + '\n' +
                              '‚è∞ Heure: ' + session.startTimeReadable;
                } else if (type === 'end') {
                    let eventsText = session.events.map(function(e, i) {
                        const by = e.addedBy ? (' ‚Äî ajout√© par ' + e.addedBy) : '';
                        return (i+1) + '. [' + e.timestampReadable + '] ' + e.description + by;
                    }).join('\n');
                    
                    if (!eventsText) eventsText = 'Aucun √©v√©nement enregistr√©';
                    
                    content = '‚èπÔ∏è **FIN DE SERVICE**\n' +
                              'üë• Agents: ' + session.agents.map(a => a.name).join(', ') + '\n' +
                              'üìç Lieu: ' + session.location + '\n' +
                              'üïê Prise: ' + session.startTimeReadable + '\n' +
                              'üïë Fin: ' + session.endTimeReadable + '\n' +
                              '‚è±Ô∏è Dur√©e: ' + session.durationReadable + '\n' +
                              'üìä √âv√©nements: ' + session.events.length + '\n\n' +
                              '**D√©tail des √©v√©nements:**\n' + eventsText;
                }
                
                const payload = {
                    content: content,
                    username: 'Main Courante Bot'
                };
                
                // Envoi du webhook - Safari peut n√©cessiter le polyfill fetch
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                    mode: 'cors' // Explicite pour Safari
                });
                
                if (response.ok) {
                    addLog('‚úÖ Webhook Discord envoy√©', 'success');
                } else {
                    addLog('‚ùå Erreur webhook Discord', 'error');
                }
            } catch (error) {
                addLog('‚ùå Erreur webhook: ' + error.message, 'error');
                console.error('Erreur webhook Discord:', error);
                // Note: CORS bloquera probablement la requ√™te directe
                // En production, passer par un backend serveur
            }
        }

        /**
         * Envoyer un webhook Discord pour le rapport quotidien (embed)
         * P√©riode: hier 08:00 -> aujourd'hui 08:00
         */
        async function sendDailyReportWebhook() {
            if (!DISCORD_DAILY_WEBHOOK_URL) {
                addLog('‚ö†Ô∏è Webhook quotidien non configur√©', 'error');
                return;
            }

            try {
                // calculer la fen√™tre : hier 08:00 -> aujourd'hui 08:00
                const now = new Date();
                // today 08:00
                const today8 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0, 0, 0);
                let startPeriod = new Date(today8.getTime() - 24*3600*1000); // hier 08:00
                let endPeriod = today8; // aujourd'hui 08:00

                // si l'heure actuelle est avant 08:00, la "p√©riode d'hier->aujourd'hui" est hier-08 -> aujourd'hui-08 (aujourd'hui = ce matin)
                // sinon, si on appelle apr√®s 08:00, consid√©rer la p√©riode pr√©c√©dente (toujours hier 08 -> aujourd'hui 08)
                // R√©cup√©rer historique
                const history = JSON.parse(localStorage.getItem('sessionsHistory') || '[]');

                const sessionsInPeriod = history.filter(s => {
                    const sStart = new Date(s.startTime);
                    // session est incluse si elle commence dans la fen√™tre OR si elle a une endTime et est partiellement dans la fen√™tre
                    const sEnd = s.endTime ? new Date(s.endTime) : null;
                    const intersects = (sStart >= startPeriod && sStart < endPeriod) || (sEnd && sEnd > startPeriod && sEnd <= endPeriod) || (sStart <= startPeriod && sEnd && sEnd >= endPeriod);
                    return intersects;
                });

                if (sessionsInPeriod.length === 0) {
                    const payloadEmpty = {
                        username: 'Main Courante Bot',
                        content: `üì§ Rapport quotidien ‚Äî P√©riode: ${formatDateTime(startPeriod)} ‚Üí ${formatDateTime(endPeriod)}\nAucune vacation enregistr√©e durant cette p√©riode.`
                    };
                    await fetch(DISCORD_DAILY_WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadEmpty),
                        mode: 'cors'
                    });
                    addLog('‚úÖ Rapport quotidien envoy√© (vide)', 'success');
                    return;
                }

                // Construire embed par agent
                // regrouper sessions par agent
                const byAgent = {};
                sessionsInPeriod.forEach(s => {
                    // s.agents est un tableau d'agents (au moment du start)
                    (s.agents || []).forEach(agent => {
                        if (!byAgent[agent.name]) byAgent[agent.name] = [];
                        byAgent[agent.name].push(s);
                    });
                });

                const embeds = [];
                Object.keys(byAgent).forEach(agentName => {
                    const agentSessions = byAgent[agentName];
                    let description = agentSessions.map(sess => {
                        const evs = (sess.events || []).map(e => `‚Ä¢ [${e.timestampReadable}] ${e.description} (par ${e.addedBy || '‚Äî'})`).join('\n') || 'Aucun √©v√©nement';
                        return `**Lieu:** ${sess.location}\n**Prise:** ${sess.startTimeReadable}\n**Fin:** ${sess.endTimeReadable || '‚Äî'}\n**Dur√©e:** ${sess.durationReadable || '‚Äî'}\n**√âv√©nements:**\n${evs}`;
                    }).join('\n\n---\n\n');

                    // tronquer si trop long (Discord a des limites)
                    if (description.length > 1000) description = description.slice(0, 980) + '\n‚Ä¶';

                    embeds.push({
                        title: `Agent: ${agentName}`,
                        description: description,
                        type: 'rich'
                    });
                });

                const payload = {
                    username: 'Main Courante Bot - Rapport',
                    embeds: embeds
                };

                const response = await fetch(DISCORD_DAILY_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'cors'
                });

                if (response.ok) {
                    addLog('‚úÖ Rapport quotidien envoy√©', 'success');
                } else {
                    addLog('‚ùå Erreur envoi rapport quotidien', 'error');
                }
            } catch (err) {
                addLog('‚ùå Erreur rapport quotidien: ' + err.message, 'error');
                console.error(err);
            }
        }

        /**
         * Planifier l'envoi quotidien √† 08:00 (fonctionne tant que la page reste ouverte)
         */
        function scheduleDailyReport() {
            try {
                const now = new Date();
                // prochaine occurrence de 08:00
                let next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8,0,0,0);
                if (now >= next) {
                    // si on est d√©j√† pass√© aujourd'hui 08:00, planifier demain 08:00
                    next = new Date(next.getTime() + 24*3600*1000);
                }
                const delay = next.getTime() - now.getTime();
                addLog('Planning rapport quotidien pour: ' + formatDateTime(next), 'success');
                setTimeout(async function tick() {
                    await sendDailyReportWebhook();
                    // programmer le prochain dans 24h
                    setTimeout(tick, 24*3600*1000);
                }, delay);
            } catch (e) {
                console.error('Erreur scheduleDailyReport', e);
            }
        }

        // ========================================
        // STOCKAGE LOCAL (localStorage)
        // ========================================
        
        /**
         * Sauvegarder la session en cours dans localStorage
         * Compatible Safari - n'utilise pas le spread operator
         */
        function saveSessionToLocal() {
            if (!currentSession) return;
            
            const sessionData = Object.assign({}, currentSession, {
                events: events
            });
            
            try {
                localStorage.setItem('currentSession', JSON.stringify(sessionData));
            } catch (e) {
                addLog('‚ùå Erreur sauvegarde: ' + e.message, 'error');
                console.error('Erreur localStorage:', e);
            }
        }

        /**
         * Sauvegarder une session termin√©e dans l'historique
         */
        function saveCompletedSession() {
            if (!currentSession) return;
            
            let history = JSON.parse(localStorage.getItem('sessionsHistory') || '[]');
            history.push(currentSession);
            localStorage.setItem('sessionsHistory', JSON.stringify(history));
            localStorage.removeItem('currentSession');
        }

        /**
         * Exporter l'historique en JSON (compatible Safari)
         */
        function exportData() {
            const history = JSON.parse(localStorage.getItem('sessionsHistory') || '[]');
            
            if (history.length === 0) {
                alert('‚ö†Ô∏è Aucune donn√©e √† exporter.');
                return;
            }
            
            const dataStr = JSON.stringify(history, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Safari n√©cessite une gestion diff√©rente du t√©l√©chargement
            if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                // Pour IE/Edge
                window.navigator.msSaveOrOpenBlob(dataBlob, 'main_courante_export_' + Date.now() + '.json');
            } else {
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'main_courante_export_' + Date.now() + '.json';
                
                // Safari n√©cessite que le lien soit dans le DOM
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Nettoyer l'URL apr√®s un d√©lai pour Safari
                setTimeout(function() {
                    URL.revokeObjectURL(url);
                }, 100);
            }
            
            addLog('üíæ Historique export√©', 'success');
        }

        /**
         * R√©initialiser le stockage local (compatible Safari)
         */
        function clearStorage() {
            if (!confirm('‚ö†Ô∏è Voulez-vous vraiment supprimer toutes les donn√©es sauvegard√©es ?')) {
                return;
            }
            
            try {
                localStorage.removeItem('sessionsHistory');
                localStorage.removeItem('currentSession');
                addLog('üóëÔ∏è Stockage r√©initialis√©', 'success');
                updateStats();
            } catch (e) {
                addLog('‚ùå Erreur lors de la r√©initialisation', 'error');
                console.error('Erreur clearStorage:', e);
            }
        }

        // ========================================
        // BACKEND PHP (OPTIONNEL - D√âCOMMENTER POUR ACTIVER)
        // ========================================
        
        /**
         * Envoyer les donn√©es au backend PHP pour enregistrement SQL
         * D√âCOMMENTER cette fonction et l'appel dans endService() pour activer
         */
        /*
        async function saveToBackend(session) {
            if (!BACKEND_URL) {
                addLog('‚ö†Ô∏è URL backend non configur√©e', 'error');
                return;
            }
            
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(session)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLog('‚úÖ Donn√©es enregistr√©es en base de donn√©es', 'success');
                } else {
                    addLog(`‚ùå Erreur base de donn√©es: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erreur backend: ${error.message}`, 'error');
                console.error('Erreur backend:', error);
            }
        }
        */

        // ========================================
        // UTILITAIRES
        // ========================================
        
        /**
         * Formater une date en format lisible (compatible Safari)
         */
        function formatDateTime(date) {
            const d = new Date(date);
            // Safari n√©cessite un format sp√©cifique pour les dates ISO
            if (isNaN(d.getTime())) {
                // Fallback si la date n'est pas valide
                return 'Date invalide';
            }
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            return d.toLocaleDateString('fr-FR', dateOptions) + ' √† ' + d.toLocaleTimeString('fr-FR', timeOptions);
        }

        /**
         * Formater l'heure uniquement (compatible Safari)
         */
        function formatTime(date) {
            const d = new Date(date);
            if (isNaN(d.getTime())) {
                return 'Heure invalide';
            }
            const options = { hour: '2-digit', minute: '2-digit', second: '2-digit' };
            return d.toLocaleTimeString('fr-FR', options);
        }

        /**
         * Formater une dur√©e en secondes
         */
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours}h ${minutes}min ${secs}s`;
        }

        /**
         * √âchapper le HTML pour √©viter les injections XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * Ajouter une entr√©e au journal d'activit√© (compatible Safari)
         */
        function addLog(message, type) {
            type = type || '';
            const logArea = document.getElementById('logArea');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry ' + type;
            const timestamp = new Date().toLocaleTimeString('fr-FR', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            logEntry.textContent = '[' + timestamp + '] ' + message;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        /**
         * Mettre √† jour les statistiques affich√©es
         */
        function updateStats() {
            // Compter les √©v√©nements
            document.getElementById('eventCount').textContent = events.length;
            
            // Compter les sessions sauvegard√©es
            const history = JSON.parse(localStorage.getItem('sessionsHistory') || '[]');
            document.getElementById('sessionCount').textContent = history.length;
        }

        /**
         * Rafra√Æchir les UI liant les agents connect√©s / agent actif
         */
        function refreshAgentsUI() {
            // liste des agents connect√©s dans la zone de d√©marrage
            const agentsSelect = document.getElementById('agentsConnected');
            agentsSelect.innerHTML = '';
            loggedInAgents.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a.id;
                opt.textContent = a.name;
                agentsSelect.appendChild(opt);
            });

            // si une session est active, remplir le select 'activeAgentSelect'
            const activeSelect = document.getElementById('activeAgentSelect');
            if (currentSession && activeSelect) {
                activeSelect.innerHTML = '';
                currentSession.agents.forEach(a => {
                    const opt = document.createElement('option');
                    opt.value = a.id;
                    opt.textContent = a.name;
                    activeSelect.appendChild(opt);
                });
                // s√©lectionner le premier si rien
                if (!activeSelect.value && activeSelect.options.length > 0) activeSelect.selectedIndex = 0;
            }
        }

        /**
         * D√©marrer le flow "Ajouter Agent" :
         * - met un flag qui fait que lors du prochain login, l'agent sera ajout√© √† loggedInAgents
         * - affiche le panneau de connexion
         */
        function startAddAgent() {
            addAgentMode = true;
            // afficher le panneau de login
            document.getElementById('loginPanel').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('loginId').focus();
            addLog('Mode "Ajouter Agent" activ√© ‚Äî veuillez connecter le nouvel agent.', 'success');
        }

        /**
         * Initialisation au chargement de la page
         */
        window.onload = function() {
            addLog('Application d√©marr√©e', 'success');
            updateStats();
            
            // Restaurer une session en cours si elle existe
            const savedSession = localStorage.getItem('currentSession');
            if (savedSession) {
                addLog('‚ö†Ô∏è Session interrompue d√©tect√©e', 'error');
            }

            // planifier le rapport quotidien
            scheduleDailyReport();
        };
    </script>
</body>
</html>
